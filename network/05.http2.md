## http1.1

1. 长链接

http 协议的初始版本中，**每进行一次 http 通信就要断开一次 tcp 链接**，也就是短链接。

为了减少通信的开销，有些浏览器在请求时，用了一个非标准的 `Connection: keep-alive` 字段，要求服务器不要关闭 tcp 链接（因为非标准，不同实现的行为可能不一致）。

http1.1 版本发布引入了**持久链接**，tcp 链接默认不关闭，可以被多个请求复用，不需要再声明 `Connection: keep-alive`。也可以主动关闭，客户端在最后一个请求时发送 `Connection: close`。

2. 管道机制

从前发送请求后需等待及接收响应，才能发送下一个请求。

管道化技术出现后不用等待响应即可直接发送下一个请求，这样可以**同时并行发送多个请求**。

3. 分块传输

一个 tcp 链接可以传送多个回应，需要 `Content-Length` 字段声明本次回应的数据长度，例如 `Content-Length: 3000` 告诉浏览器本次回应的长度是 3000 字节，后面的字节就属于下一个回应了。

1.1 规定可以不使用 `Content-Length` 字段，而是用**分块传输编码**，在请求或者响应头信息添加 `Transfer-Encoding: chunked` 表明响应将由数量未定的数据块组成，每个非空数据块之前会有一个 16 进制的数值，表示这个块的长度，直到为 0 表示本次回应的数据发送完成。

同一个 tcp 链接里所有通信都是**按次序进行**的，服务器只有处理完一个回应才会进行下一个回应，当前面的请求未完成，使得后续请求排队，称为**队头阻塞**。

优化手段：

1. 减少请求数：合并脚本和样式表，将图片嵌入 css 代码
2. 多开持续请求：域名分片

## http2

1. 二进制协议

1.1 请求头信息肯定是文本，数据体可以是文本也可以是二进制；2 则是彻底的二进制协议，头信息和数据体都是二进制，并且统称为帧。

二进制协议可以定义额外的帧，为将来的高级应用打好基础（文本实现在解析数据时非常麻烦），二进制解析则方便很多。

2. 多路复用

2 复用 tcp 链接，在一个链接里，客户端和浏览器都可以同时发送多个请求或回应，且**不用按顺序**一一对应，避免了堵塞。

服务器可以在同时收到 A,B 请求后，回应 A 请求时发现处理过程非常耗时，可以先发送 A 请求处理好的部分，再回应 B 请求，之后再发哦是那个 A 请求剩余的部分。

因为不按顺序，同一链接的数据包可能属于不同的回应，因此需要对数据包做标记 id，区分属于那个数据流（客户端发送的 id 为奇数，服务端的为偶数）。

1.1 取消数据唯一的方法就是关闭 tcp 链接，2 可以发送信号取消这个数据流，同时保持 tcp 链接，可以被其他请求使用。

客户端还可以指定数据流的优先级，让服务器优先回应。

3. 压缩头信息

http 协议不带状态，**每次请求都必须附上所有信息**，包括重复的字段 Cookie, User Agent 等。

2 引入了头信息压缩，使用 `gzip` 或 `compress` 压缩后发送

同时客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号用以发送。

4. 服务器推送

常见场景：以往客户端收到网页后解析 html 编码，发现有静态资源再发出静态资源请求；服务器可预期客户端请求网页和很可能会再请求静态资源，2 允许其主动把这些静态资源随网页一起发送给客户端。
