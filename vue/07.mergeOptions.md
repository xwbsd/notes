## mergeOptions

new Vue 的过程通常有 2 种场景：

- 外部主动调用 new Vue(options)
- 子组件创建过程 new vnode.componentOptions.Ctor(options)

它们都会执行实例过程的 `_init(options)` 方法，并执行 mergeOptions 方法，但是它们的对 options 的合并逻辑不同，传入的 options 也非常不同。

### 外部调用

```javascript
vm.$options = mergeOptions(
  resolveConstructorOptions(vm.constructor),
  options || {},
  vm
);
```

resolveConstructorOptions 在这个场景简单返回 vm.constructor.options，相当于 `Vue.options`，即：

```javascript
// src/shared/constants.js
export const ASSET_TYPES = ["component", "directive", "filter"];

// src/core/global-api/index.js
export function initGlobalAPI(Vue) {
  // ...
  Vue.options = Object.create(null);
  ASSET_TYPES.forEach((type) => {
    Vue.options[type + "s"] = Object.craete(null);
  });

  // this is used to identify the "base" constructor to extend all plain-object
  Vue.options._base = Vue;

  /**
   * 把一些内置组件拓展到 Vue.options.components 上
   * <keep-alive> <transition> <transition-group>
   */
  extend(Vue.options.components, builtInComponents);
  // ...
}
```

> src/core/util/options.js

```javascript
// core utility used in both instantiation and inheritance
export function mergeOptions(parent, child, vm) {
  if (process.env.NODE_ENV !== "production") {
    checkComponents(child);
  }
  if (typeof child === "function") {
    child = child.options;
  }

  normalizeProps(child, vm);
  normalizeInject(child, vm);
  normalizeDirectives(child);
  /**
   * 递归把 extends 和 mixins 合并到 parent 上
   */
  const extendsFrom = child.extends;
  if (extendsFrom) {
    parent = mergeOptions(parent, extendsFrom, vm);
  }
  if (child.mixins) {
    for (let i = 0, l = child.mixins.length; i < l; i++) {
      parent = mergeOptions(parent, child.mixins[i], vm);
    }
  }
  const options = {};
  let key;
  /**
   * 遍历 parent，调用 mergeField
   */
  for (key in parent) {
    mergeField(key);
  }
  /**
   * 遍历 child，若 key 不在 parent 自身属性上，调用 mergeField
   */
  for (key in child) {
    if (!hasOwn(parent, key)) {
      mergeField(key);
    }
  }
  function mergeField(key) {
    const strat = strats[key] || defaultStrat;
    options[key] = strat(parent[key], child[key], vm, key);
  }
  return options;
}
```
