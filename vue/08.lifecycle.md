## lifecycle

每个 Vue 实例在被创建之前都要经过一系列的初始化过程，例如需要设置数据监听、编译模板、挂载实例、数据更新 DOM 等，在这个过程中也会运行一些叫做生命周期钩子的函数，可以在一些特性的场景下添加自己的代码。

![vue lifecycle](https://cn.vuejs.org/images/lifecycle.png)

Vue 中最终执行生命周期的函数都是调用 callHook 方法

> src/core/instance/lifecycle.js

```javascript
export function callHook(vm, hook) {
  // disable dep collection when invoking lifecycle hooks
  pushTarget()
  /**
   * Vue 合并 options 后各个阶段的生命周期函数合并到 vm.$options
   * vm.$options[hook] 是一个数组，遍历执行，并传入 vm 上下文
   */
  const handlers = vm.$options[hook]
  if (handlers) {
    for (let i = 0, j = handlers.length; i < j; i++) {
      try {
        handlers[i].call(vm)
      } catch (e) {
        handleError(e, vm, `${hook} hook`)
      }
    }
  }
  if (vm._hasHookEvent) {
    vm.$emit("hook:" + hook)
  }
  popTarget()
}
```

### beforeCreate & created

> src/core/instance/init.js

```javascript
Vue.prototype._init = function (options) {
  // ...
  initLifecycle(vm)
  initEvents(vm)
  initRender(vm)
  /**
   * 调用在 initState 前后
   * initState 初始化了 props, data, methods, watch, computed
   * 所以 beforeCreate 无法获得 props, data, methods 等
   */
  callHook(vm, "beforeCreate")
  initInjections(vm)
  initState(vm)
  initProvide(vm)
  /**
   * 两个钩子函数执行时，均未渲染 DOM，所以不能访问 DOM
   * 后端交互可以放在这两个钩子函数内
   * created 可以访问 props, data 等数据
   */
  callHook(vn, "created")
  // ...
}
```

### beforeMount & mounted

> src/core/instance/lifecycle.js

```javascript
export function mountComponent(vm, el, hydrating) {
  vm.$el = el
  // ...
  /**
   * 执行在 vm._render 渲染 VNode 之前
   */
  callHook(vm, "beforeMount")

  let updateComponent
  if (process.env.NODE_ENV !== "production" && config.performance && mark) {
    // ...
  } else {
    updateComponent = () => {
      /**
       * vm._update 把 VNode patch 到真实 DOM 之后，执行 mounted
       */
      vm._update(vm._render(), hydrating)
    }
  }

  // we set this to vm._watcher inside ther watcher's constructor
  // since this watcher's initial patch may call $forceUpdate, which relise on vm._watcher being already defined
  new Watcher(
    vm,
    updateComponent,
    noop,
    {
      before() {
        if (vm._isMounted) {
          callHook(vm, "beforeUpdate")
        }
      },
    },
    true /* isRenderWatcher */
  )
  hydrating = false

  // manually mounted instance, call mounted on self
  // mounted is called for render-created child components in its inserted hook
  if (vm.$vnode == null) {
    vm._isMounted = true
    callHook(vm, "mounted")
  }
  return vm
}
```
