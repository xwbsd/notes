## 异步处理方式的改变

回调函数 > Promsie > Generator > async

> 查找指定目录下的最大文件为例，这需要 Nodejs 的一些 API

1. fs.readdir: 读取目录，返回一个包含文件和目录的数组；
2. fs.stat: 其参数是一个文件或目录，返回一个包含该文件或目录具体形象的对象，对象中还有一个方法 isFile() 判断当前项是文件还是目录

### 回调函数

```javascript
var fs = require("fs")
var path = require("path")

function findLargest(dir, cb) {
  fs.readdir(dir, function (er, files) {
    if (er) return cb(er)

    var counter = files.length
    var errored = false
    var stats = []

    files.forEach(function (file, index) {
      fs.stats(path.join(dir, file), function (er, stat) {
        if (errored) return
        if (er) {
          errored = true
          return cb(er)
        }

        stats[index] = stat

        // counter 为 0 时，读取完成，进行比较
        if (--counter == 0) {
          var largest = stats
            .filter(function (stat) {
              return stat.isFile()
            })
            .reduce(function (prev, next) {
              if (prev.size > next.size) return prev
              return next
            })

          cb(null, files[stats.indexOf(largest)])
        }
      })
    })
  })
}

// 使用方式
findLargest("./", function (er, fileName) {
  if (er) return console.log(er)
  console.log("largest file is: ", fileName)
})
```

## Promise

```javascript
var fs = require("fs")
var path = require("path")

var readDir = function (dir) {
  return new Promise(function (resolve, reject) {
    fs.readdir(dir, function (er, files) {
      if (er) reject(er)
      resolve(files)
    })
  })
}

var stat = function (path) {
  return new Promise(function (resolve, reject) {
    fs.stat(path, function (er, stat) {
      if (er) reject(er)
      resolve(stat)
    })
  })
}

var findLargest = function (dir) {
  return readDir(dir)
    .then(function (files) {
      let promises = files.map((file) => stat(path.join(dir, file)))
      return Promise.all(promises).then(function (stats) {
        return { stats, files }
      })
    })
    .then(function (data) {
      let largest = data.stats
        .filter((stat) => stat.isFile())
        .reduce((prev, next) => {
          if (prev.size > next.size) return prev
          return next
        })
      return data.files[data.stats.indexOf(largest)]
    })
}

// 使用方式
findLargest("./")
  .then(function (fileName) {
    console.log("largest file is: ", fileName)
  })
  .catch(function (err) {
    cosole.log(err)
  })
```

## Generator

```javascript
var fs = require("fs")
var path = require("path")

var co = require("co")

var readDir = function (dir) {
  return new Promise(function (resolve, reject) {
    fs.readdir(dir, function (er, files) {
      if (er) reject(er)
      resolve(files)
    })
  })
}

var stat = function (path) {
  return new Promise(function (resolve, reject) {
    fs.stat(path, function (er, stat) {
      if (er) reject(er)
      resolve(stat)
    })
  })
}

function* findLargest(dir) {
  var files = yield readDir(dir)
  var stats = yield files.map(function (file) {
    return stat(path.join(dir, file))
  })

  let largest = stats
    .filter((stat) => stat.isFile())
    .reduce((prev, next) => {
      if (prev.size > next.size) return prev
      return next
    })
  return files[stats.indexOf(largest)]
}

// 使用方式
co(findLargest, "./")
  .then(function (fileName) {
    console.log("largest file is: ", fileName)
  })
  .catch(function (err) {
    cosole.log(err)
  })
```

## Async

```javascript
var fs = require("fs")
var path = require("path")

var readDir = function (dir) {
  return new Promise(function (resolve, reject) {
    fs.readdir(dir, function (er, files) {
      if (er) reject(er)
      resolve(files)
    })
  })
}

var stat = function (path) {
  return new Promise(function (resolve, reject) {
    fs.stat(path, function (er, stat) {
      if (er) reject(er)
      resolve(stat)
    })
  })
}

async function findLargest(dir) {
  var files = await readDir(dir)
  var stats = files.map(async (file) => await stat(path.join(dir, file)))

  let largest = stats
    .filter((stat) => stat.isFile())
    .reduce((prev, next) => {
      if (prev.size > next.size) return prev
      return next
    })
  return files[stats.indexOf(largest)]
}

// 使用方式
findLargest("./")
  .then(function (fileName) {
    console.log("largest file is: ", fileName)
  })
  .catch(function (err) {
    cosole.log(err)
  })
```
